<?php$glabal=false;require('/data/sites/benelux/www/configure/application_top.php');//require('/Users/gs/site_local/trunk/configure/application_top.php');?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Document sans nom</title></head><body><?php		$counter=0;	$couter_id=0;	function wd_remove_accents($str, $charset='utf-8')	{		$str = htmlentities($str, ENT_NOQUOTES, $charset);				$str = preg_replace('#\&([A-za-z])(?:acute|cedil|circ|grave|ring|tilde|uml)\;#', '\1', $str);		$str = preg_replace('#\&([A-za-z]{2})(?:lig)\;#', '\1', $str); // pour les ligatures e.g. '&oelig;'		$str = preg_replace('#\&[^;]+\;#', '', $str); // supprime les autres caractères				return $str;	}//	include 'login.php';		$droselia_category = tep_db_query("SELECT category_id , category_fr  FROM `droselia_category_stream` ;",'db_link',true) ;	while ($droselia_category_values = tep_db_fetch_array($droselia_category)){		$cat_val = wd_remove_accents(utf8_encode($droselia_category_values['category_fr']));		$tab_category[$cat_val]=$droselia_category_values['category_id'];		}		//echo '<br>--------<br>';	    $xml = new DomDocument('1.0');	if(empty($_GET['full']))		$xml->load('http://feeds2.droselia.com/d75fb5e4c53c50550eb7a961e6409132f25bda35/smartmovies/document-34227/videos/1/0.xml?nbdays=10');	else		$xml->load('http://feeds2.droselia.com/d75fb5e4c53c50550eb7a961e6409132f25bda35/smartmovies/document-34227/videos/1/0.xml');		foreach($xml->getElementsBytagName('item') as $video){	   $couter_id++;	   	   $id = $video->getElementsByTagName('id')->item(0)->firstChild->nodeValue;	   	   $date = $video->getElementsByTagName('date')->item(0)->firstChild->nodeValue;		   $nom = $video->getElementsByTagName('nom')->item(0)->firstChild->nodeValue;	   	   $nom = str_replace("<b>","",$nom);	   $nom = str_replace("</b>","",$nom);	   $nom = str_replace("’","\'",$nom);	   $nom = utf8_decode($nom);	   $description = $video->getElementsByTagName('description')->item(0)->firstChild->nodeValue;	   	   $description = str_replace("<b>","",$description);	   $description = str_replace("</b>","",$description);	   $description = str_replace("’","\'",$description);	   	   //$description = str_replace("&rsquo;","'",$description);	   $description = utf8_decode($description);		   	   $preview_description = $video->getElementsByTagName('preview_description')->item(0)->firstChild->nodeValue;	   $preview_description = str_replace("<b>","",$preview_description);	   $preview_description = str_replace("</b>","",$preview_description);	   $preview_description = str_replace("’","\'",$preview_description);	   //$preview_description = str_replace("’","'",$preview_description);	   //$preview_description = str_replace("&rsquo;","'",$preview_description);	   $preview_description = utf8_decode($preview_description);		   	   $duree = $video->getElementsByTagName('duree')->item(0)->firstChild->nodeValue;	   	   $taille = $video->getElementsByTagName('taille')->item(0)->firstChild->nodeValue;	   	   //$format = $video->getElementsByTagName('format')->item(0)->firstChild->nodeValue;	   	   //$file = $video->getElementsByTagName('file')->item(0)->firstChild->nodeValue;	   	   //$hq = $video->getElementsByTagName('hq')->item(0)->firstChild->nodeValue;	   //if ($hq =='true'){$quality=1;}else{$quality=0;}	  $quality=1;	   	   $langue_fr = $video->getElementsByTagName('langue_fr')->item(0)->firstChild->nodeValue;	   if ($langue_fr =='true'){$lang=1;}else{$lang=0;}	   	   $top_rank = $video->getElementsByTagName('top_rank')->item(0)->firstChild->nodeValue;	   	   $trash_xml = $video->getElementsByTagName('niche')->item(0)->firstChild->nodeValue;	   if ($trash_xml =='true'){$trash='YES';}else{$trash='NO';}	   $top_rank_before = $video->getElementsByTagName('top_rank_before')->item(0)->firstChild->nodeValue;			   $dossier_thumb = $video->getElementsByTagName('dossier_thumb')->item(0)->firstChild->nodeValue;	   	   $nb_thumbs = $video->getElementsByTagName('nb_thumbs')->item(0)->firstChild->nodeValue;		$i=0;	   	foreach($video->getElementsBytagName('file') as $file){			$file = $video->getElementsByTagName('file')->item($i)->firstChild->nodeValue;			if(strpos(strtolower($file),'avi')!==false)			{				$file_avi=$file;			}			if(strpos(strtolower($file),'m4v')!==false)			{				$file_m4v=$file;			}			if(strpos(strtolower($file),'flv')!==false)			{				$file_flv=$file;			}			if(strpos(strtolower($file),'mpg')!==false)			{				$file_mpg=$file;			}						$i++;		}	   //$vignettes_censurees_dispo = $video->getElementsByTagName('vignettes_censurees_dispo')->item(0)->firstChild->nodeValue;	   //if ($vignettes_censurees_dispo =='oui'){$censored=1;}else{$censored=0;}	   	  // echo $id .'<br>'. $date.'<br>'.$nom.'<br>'.$description.'<br>'.$preview_description.'<br>'.$duree.'<br>'.$taille.'<br>'.$format.'<br>'.$file.'<br>'.$quality.'<br>'.$lang.'<br>'.$top_rank.'<br>'.$top_rank_begore.'<br>'.$dossier_thumb.'<br>'.$nb_thumbs.'<br>'.$censored.'<br><br>';				$in_catalog = tep_db_query("SELECT count(catalog_id) as cpt FROM `droselia_catalog_stream` where catalog_id=".$id." ;",'db_link',true) ;		$in_catalog_values = tep_db_fetch_array($in_catalog);		if ($in_catalog_values['cpt'] == 0) {					$cpt=0;			foreach($video->getElementsBytagName('category') as $cat){				$category = $video->getElementsByTagName('category')->item($cpt)->firstChild->nodeValue;							$category =wd_remove_accents($category);								$sql='select * from droselia_category_stream where category_fr="'.$category.'"';			    // echo $sql.'<br />';				$query_cat=tep_db_query($sql,'db_link',true);				if ($cat_values = tep_db_fetch_array($query_cat))				{					$inject_droselia_cat="INSERT INTO `droselia_category_to_catalog_stream` (`catalog_id` ,`category_id` ) VALUES ( '$id', '$tab_category[$category]')";					if($tab_category[$category]==4 || $tab_category[$category]==20 || $tab_category[$category]==80|| $tab_category[$category]==38|| $tab_category[$category]==77|| $tab_category[$category]==44|| $tab_category[$category]==78|| $tab_category[$category]==79)					{						$trash='YES';					}					//echo $inject_droselia_cat.'<br />';					$injected_cat=tep_db_query($inject_droselia_cat);				}				else				{					$inject_droselia_cat="INSERT INTO `droselia_category_stream` (`category_fr`,`category_en`,`category_nl`,`group` ) VALUES ( '$category','$category','$category',0)";					//$data= $inject_droselia_cat."\n";					$injected_cat=tep_db_query($inject_droselia_cat);					$cat_id=tep_db_insert_id();					if($cat_id==4 || $cat_id==20|| $cat_id==80|| $cat_id==38|| $cat_id==77|| $cat_id==44|| $cat_id==78|| $cat_id==79)					{						$trash='YES';					}					$tab_category[$category]=$cat_id;					$inject_droselia_cat="INSERT INTO `droselia_category_to_catalog_stream` (`catalog_id` ,`category_id` ) VALUES ( '$id', $cat_id)";					//echo $inject_droselia_cat.'<br />';										$injected_cat=tep_db_query($inject_droselia_cat);					$data= 'new '.$category."\n";				}																$cpt++;			}						$inject_droselia='INSERT INTO `droselia_catalog_stream` (`catalog_id` ,`date` ,`name` ,`description` ,`preview_description` ,`duration` ,`weight` ,`file_avi` ,`file_mpg` ,`file_m4v` ,`file_flv` ,`video_in_french` ,`top_rank` ,`top_rank_before` ,`directory_thumbs` ,`nb_thumbs`, `is_active`,`trash`) VALUES ( "'.$id.'", "'.$date.'" , "'.addslashes($nom).'" , "'.addslashes($description).'", "'.addslashes($preview_description).'", "'.$duree.'", "'.$taille.'",  "'.$file_avi.'", "'.$file_mpg.'", "'.$file_m4v.'", "'.$file_flv.'", "'.$lang.'", "'.$top_rank.'", "'.$top_rank_begore.'" , "'.$dossier_thumb.'", "'.$nb_thumbs.'", "1","'.$trash.'")';			//echo $inject_droselia.'<br />';			if ($injected=tep_db_query($inject_droselia)){ $counter ++ ;}		}	  					  	} $data.= date('d/m/Y H:i:s').' : '.$counter." videos injected \n" ;$fp = fopen('/data/log/droselia.log', 'a');fwrite($fp, $data);fclose($fp);?><body></html> 